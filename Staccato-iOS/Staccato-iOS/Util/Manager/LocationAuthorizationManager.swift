//
//  LocationManager.swift
//  Staccato-iOS
//
//  Created by ê¹€ìœ ë¦¼ on 2/17/25.
//

import CoreLocation
import SwiftUI
import Observation

@Observable
class LocationAuthorizationManager: NSObject {
    
    // MARK: - Properties
    
    static let shared = LocationAuthorizationManager()
    
    private var locationManager = CLLocationManager()
    
    var hasLocationAuthorization: Bool = false
    
    
    // MARK: - Methods
    
    override init() {
        super.init()
        locationManager.delegate = self
        updateAuthorizationStatus()
    }
    
    private func updateAuthorizationStatus() {
        let status = locationManager.authorizationStatus
        hasLocationAuthorization = (status == .authorizedAlways || status == .authorizedWhenInUse)
    }
    
    func checkLocationAuthorization() {
        let status = locationManager.authorizationStatus
        
        switch status {
        case .notDetermined:
            // ì²˜ìŒ ì‹¤í–‰ ì‹œ ê¶Œí•œ ìš”ì²­
            print("ğŸ—ºï¸Location authorization: NotDetermined")
            locationManager.requestWhenInUseAuthorization()
            
        case .restricted, .denied:
            // ê¶Œí•œ ê±°ë¶€ ìƒíƒœ: ì„¤ì • ì•±ìœ¼ë¡œ ìœ ë„
            print("ğŸ—ºï¸Location authorization: Restricted or Denied")
            showAlertToOpenSettings()
            
        case .authorizedWhenInUse, .authorizedAlways:
            // "ì•± ì‚¬ìš© ì¤‘ í—ˆìš©" ìƒíƒœ: ì•± í”Œë¡œìš° ì§„ì…
            print("ğŸ—ºï¸Location authorization: AuthorizedWhenInUse or AuthorizedAlways")
            
        @unknown default:
            break
        }
    }
    


    private func showAlertToOpenSettings() {
        // ì„¤ì • ì•±ìœ¼ë¡œ ìœ ë„í•˜ëŠ” Alert
        if let settingsURL = URL(string: UIApplication.openSettingsURLString) {
            let alert = UIAlertController(
                title: "ìœ„ì¹˜ ê¶Œí•œ í•„ìš”",
                message: "Staccato ì‚¬ìš©ì„ ìœ„í•´ ì„¤ì •ì—ì„œ ìœ„ì¹˜ì ‘ê·¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.",
                preferredStyle: .alert
            )
            alert.addAction(UIAlertAction(title: "ì·¨ì†Œ", style: .cancel, handler: nil))
            alert.addAction(UIAlertAction(title: "ì„¤ì • ì—´ê¸°", style: .default) { _ in
                UIApplication.shared.open(settingsURL)
            })

            // TODO: ë¦¬íŒ©í† ë§ ('windows' was deprecated in iOS 15.0)
            if let topVC = UIApplication.shared.windows.first?.rootViewController {
                topVC.present(alert, animated: true, completion: nil)
            }
        }
    }
    
}


// MARK: - CLLocationManagerDelegate

extension LocationAuthorizationManager: CLLocationManagerDelegate {
    
    func locationManager(_ manager: CLLocationManager, didChangeAuthorization status: CLAuthorizationStatus) {
        // ê¶Œí•œ ìƒíƒœ ë³€ê²½ ì‹œ ì²˜ë¦¬
        checkLocationAuthorization()
        updateAuthorizationStatus()
    }

}
